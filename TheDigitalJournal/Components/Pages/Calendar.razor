@page "/calendar"
@using System
@using System.Collections.Generic
@using System.Linq
@using System.Threading.Tasks
@using TheDigitalJournal.ViewModels
@using TheDigitalJournal.Utils
@inject CalendarViewModel ViewModel
@inject NavigationManager Navigation

<div class="calendar-container">
    <div class="calendar-header">
        <h1>üìÖ Calendar View</h1>
        <div class="calendar-controls">
            <button class="nav-btn" @onclick="() => ViewModel.ChangeMonthAsync(-1)">‚Äπ</button>
            <span class="current-month">@ViewModel.CurrentMonth.ToString("MMMM yyyy")</span>
            <button class="nav-btn" @onclick="() => ViewModel.ChangeMonthAsync(1)">‚Ä∫</button>
            <button class="today-btn" @onclick="GoToToday">Today</button>
        </div>
    </div>

    <div class="calendar-content">
        <div class="calendar-grid-wrapper card">
            <div class="calendar-grid">
                <div class="calendar-weekday">Sun</div>
                <div class="calendar-weekday">Mon</div>
                <div class="calendar-weekday">Tue</div>
                <div class="calendar-weekday">Wed</div>
                <div class="calendar-weekday">Thu</div>
                <div class="calendar-weekday">Fri</div>
                <div class="calendar-weekday">Sat</div>

                @foreach (var day in GetCalendarDays())
                {
                    var entry = ViewModel.MonthEntries.FirstOrDefault(e => e.Date.Date == day.Date);
                    var primaryMood = entry?.Moods.FirstOrDefault();
                    <div class="calendar-day @(day.Month != ViewModel.CurrentMonth.Month ? "other-month" : "") @(day.Date == DateTime.Today ? "today" : "") @(entry != null ? "has-entry" : "")"
                         @onclick="() => SelectDay(day)">
                        <span class="day-number">@day.Day</span>
                        @if (primaryMood != null)
                        {
                            <span class="mood-indicator">@primaryMood.Icon</span>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="entry-preview-panel card">
            @if (ViewModel.SelectedEntry != null)
            {
                <div class="preview-header">
                    <h3>@ViewModel.SelectedEntry.Date.ToString("MMMM dd, yyyy")</h3>
                    <button class="edit-btn" @onclick="() => EditEntry(ViewModel.SelectedEntry.Id)">Edit</button>
                </div>

                <div class="preview-content">
                    <div class="preview-title">
                        @(string.IsNullOrWhiteSpace(ViewModel.SelectedEntry.Title) ? "Untitled Entry" : ViewModel.SelectedEntry.Title)
                    </div>
                    <div class="preview-moods">
                        @foreach (var mood in ViewModel.SelectedEntry.Moods)
                        {
                            bool isPrimary = ViewModel.SelectedEntry.Moods.IndexOf(mood) == 0;
                            <span class="mood-badge @(isPrimary ? "primary" : "")">@mood.Icon @mood.Name</span>
                        }
                    </div>

                    <div class="preview-tags">
                        @foreach (var tag in ViewModel.SelectedEntry.Tags)
                        {
                            <span class="preview-tag">#@tag.Name</span>
                        }
                    </div>

                    <div class="preview-text">
                        @((MarkupString)DbConstants.MarkdownToHtml(ViewModel.SelectedEntry.Content))
                    </div>

                    <div class="preview-stats">
                        <span>üìù @GetWordCount(ViewModel.SelectedEntry.Content) words</span>
                    </div>
                </div>
            }
            else
            {
                <div class="empty-preview">
                    <p>Select a day with an entry to see preview.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    protected override async Task OnInitializedAsync() => await ViewModel.InitializeAsync();

    private IEnumerable<System.DateTime> GetCalendarDays()
    {
        var firstDayOfMonth = new System.DateTime(ViewModel.CurrentMonth.Year, ViewModel.CurrentMonth.Month, 1);
        var startDay = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        for (int i = 0; i < 42; i++) yield return startDay.AddDays(i);
    }

    private async Task GoToToday()
    {
        ViewModel.CurrentMonth = System.DateTime.Today;
        await ViewModel.LoadMonthEntriesAsync();
    }

    private void SelectDay(System.DateTime date) => ViewModel.SelectEntry(date);
    private void EditEntry(int id) => Navigation.NavigateTo($"today/{id}");
    private int GetWordCount(string content) => string.IsNullOrWhiteSpace(content) ? 0 : content.Split(new[] { ' ', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries).Length;
}

<style>
    .calendar-container { max-width: 1600px; margin: 0 auto; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .calendar-controls { display: flex; align-items: center; gap: 1rem; }
    .nav-btn { width: 36px; height: 36px; border: 1px solid var(--border); background: var(--bg-card); border-radius: 8px; cursor: pointer; color: var(--text-main); }
    .current-month { font-size: 1.125rem; font-weight: 600; min-width: 150px; text-align: center; color: var(--text-main); }
    .today-btn { padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    
    .calendar-content { display: grid; grid-template-columns: 1fr 400px; gap: 1.5rem; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
    .calendar-weekday { text-align: center; padding: 0.5rem; font-weight: 700; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
    .calendar-day { aspect-ratio: 1; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background: var(--bg-page); }
    .calendar-day:hover { border-color: var(--primary); background: var(--bg-card); }
    .calendar-day.other-month { opacity: 0.2; }
    .calendar-day.today { border: 2px solid var(--primary); font-weight: 800; }
    .calendar-day.has-entry { background: rgba(5, 150, 105, 0.05); border-color: rgba(5, 150, 105, 0.2); }
    .day-number { font-size: 0.9rem; color: var(--text-main); }
    .mood-indicator { font-size: 1.1rem; margin-top: 0.25rem; }
    
    .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
    .preview-header h3 { font-size: 1rem; color: var(--text-main); }
    .edit-btn { padding: 0.4rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
    .preview-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-main); }
    .mood-badge { padding: 0.3rem 0.6rem; background: var(--bg-page); border: 1px solid var(--border); border-radius: 6px; font-size: 0.8rem; margin-right: 0.5rem; color: var(--text-main); }
    .mood-badge.primary { background: var(--primary); color: white; border: none; }
    .preview-tags { margin: 1rem 0; display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .preview-tag { color: var(--primary); font-weight: 600; font-size: 0.8rem; }
    .preview-text { margin: 1.5rem 0; line-height: 1.6; color: var(--text-secondary); font-family: serif; }
    .preview-stats { border-top: 1px solid var(--border); padding-top: 1rem; font-size: 0.8rem; color: var(--text-muted); font-family: sans-serif; }
    .empty-preview { text-align: center; padding: 4rem 0; color: var(--text-muted); }
</style>