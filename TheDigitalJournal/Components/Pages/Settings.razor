@page "/settings"
@using TheDigitalJournal.Services
@using TheDigitalJournal.Data
@using TheDigitalJournal.Utils
@using Microsoft.Maui.Controls
@using Microsoft.Maui.ApplicationModel
@using Microsoft.Maui.Storage
@using System.IO
@inject ISecurityService SecurityService
@inject IThemeService ThemeService
@inject IExportService ExportService
@inject IPrintService PrintService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<div class="settings-container">
    <div class="settings-header">
        <h1>‚öôÔ∏è Settings</h1>
    </div>

    <div class="settings-content">
        <div class="settings-section">
            <h2>üé® Appearance</h2>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-title">Theme Mode</div>
                    <div class="setting-description">Switch between Light and Dark professional themes</div>
                </div>
                <button class="action-btn theme-btn" @onclick="ThemeService.ToggleTheme">
                    @(ThemeService.IsDarkMode ? "‚òÄÔ∏è Switch to Light Mode" : "üåô Switch to Dark Mode")
                </button>
            </div>
        </div>

        <div class="settings-section">
            <h2>üì§ Data Management</h2>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-title">Export Journal (Compatible)</div>
                    <div class="setting-description">Generate a report. Select range below or leave empty for all.</div>
                </div>
                <div class="export-range-form">
                    <div class="date-input-group">
                        <label>From</label>
                        <input type="date" @bind="_exportStart" class="setting-input-date" />
                    </div>
                    <div class="date-input-group">
                        <label>To</label>
                        <input type="date" @bind="_exportEnd" class="setting-input-date" />
                    </div>
                    <button class="action-btn primary" @onclick="ExportJournalCompatible" disabled="@_isExporting">
                        @if (_isExporting) { <span>Generating...</span> } else { <span>Print / PDF</span> }
                    </button>
                </div>
            </div>
            
            <div class="setting-item" style="margin-top: 1rem; opacity: 0.7;">
                <div class="setting-info">
                    <div class="setting-title">Native PDF Export</div>
                    <div class="setting-description">Direct PDF generation (Restricted Support)</div>
                </div>
                <button class="action-btn" @onclick="ExportJournalNative" disabled="@_isExporting">
                    Native PDF
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_exportMessage))
            {
                <p class="status-msg @(_isExportError ? "error" : "")">@_exportMessage</p>
            }
        </div>

        <div class="settings-section">
            <h2>üîí Security</h2>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-title">Change PIN</div>
                    <div class="setting-description">Update your 4-digit access PIN</div>
                </div>
                <div class="pin-change-form">
                    <input type="password" maxlength="4" placeholder="Old" @bind="_oldPin" class="setting-input" />
                    <input type="password" maxlength="4" placeholder="New" @bind="_newPin" class="setting-input" />
                    <button class="action-btn primary" @onclick="ChangePin">Update</button>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(_pinMessage))
            {
                <p class="status-msg">@_pinMessage</p>
            }
        </div>

        <div class="settings-section danger-zone">
            <h2>‚ö†Ô∏è Danger Zone</h2>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-title">Factory Reset</div>
                    <div class="setting-description">Permanently delete ALL data and PIN</div>
                </div>
                <button class="action-btn danger" @onclick="ResetApp">Delete All</button>
            </div>
        </div>

        <div class="settings-section">
            <h2>‚ÑπÔ∏è About</h2>
            <div class="about-info">
                <div class="app-logo">üìî</div>
                <div class="app-name">The Digital Journal</div>
                <div class="app-version">Version 1.0.0</div>
            </div>
        </div>
    </div>
</div>

@code {
    private string _oldPin = "";
    private string _newPin = "";
    private string _pinMessage = "";
    private string _exportMessage = "";
    private bool _isExportError = false;
    private bool _isExporting = false;
    
    private DateTime? _exportStart;
    private DateTime? _exportEnd;

    protected override void OnInitialized()
    {
        ThemeService.OnThemeChanged += HandleThemeChanged;
    }

    private void HandleThemeChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= HandleThemeChanged;
    }

    private async Task ExportJournalCompatible()
    {
        if (_isExporting) return;
        _isExporting = true;
        _exportMessage = "";
        
        try
        {
            var html = await ExportService.ExportJournalToHtmlAsync(_exportStart, _exportEnd);
            PrintService.PrintHtml(html);
            _exportMessage = "Export generated.";
        }
        catch (Exception ex)
        {
            _isExportError = true;
            _exportMessage = "Export failed: " + ex.Message;
        }
        finally
        {
            _isExporting = false;
        }
    }

    private async Task ExportJournalNative()
    {
        if (_isExporting) return;
        _isExporting = true;
        _exportMessage = "";
        _isExportError = false;
        
        try
        {
            var filePath = await ExportService.ExportJournalToPdfAsync();
            
            if (Application.Current?.MainPage != null && !string.IsNullOrEmpty(filePath))
            {
                _exportMessage = "Journal exported successfully!";
                var open = await Application.Current.MainPage.DisplayAlert("Export Success", "Journal exported successfully.", "Open PDF", "OK");
                if (open)
                {
                    await Launcher.Default.OpenAsync(new OpenFileRequest
                    {
                        Title = "Journal Export",
                        File = new ReadOnlyFile(filePath)
                    });
                }
            }
        }
        catch (Exception)
        {
            _isExportError = true;
            _exportMessage = "Native export not supported on this platform.";
            if (Application.Current?.MainPage != null)
            {
                await Application.Current.MainPage.DisplayAlert("Platform Limitation", "The native PDF library (QuestPDF) does not support this specific device runtime. Please use the 'Compatible' export option instead.", "OK");
            }
        }
        finally
        {
            _isExporting = false;
        }
    }

    private async Task ChangePin()
    {
        try 
        {
            if (string.IsNullOrWhiteSpace(_oldPin) || string.IsNullOrWhiteSpace(_newPin) || _oldPin.Length != 4 || _newPin.Length != 4)
            {
                _pinMessage = "PIN must be 4 digits.";
                return;
            }

            var success = await SecurityService.ChangePinAsync(_oldPin, _newPin);
            if (success)
            {
                _pinMessage = "PIN updated successfully!";
                _oldPin = "";
                _newPin = "";
            }
            else
            {
                _pinMessage = "Incorrect old PIN.";
            }
        }
        catch (Exception)
        {
            _pinMessage = "Error: Failed to update PIN.";
        }
    }

    private async Task ResetApp()
    {
        try 
        {
            if (Application.Current?.MainPage != null)
            {
                var confirmed = await Application.Current.MainPage.DisplayAlert("DANGER", "This will delete EVERYTHING. Are you sure?", "Yes, Reset", "Cancel");
                if (confirmed)
                {
                    var dbPath = DbConstants.DatabasePath;
                    if (File.Exists(dbPath))
                    {
                        File.Delete(dbPath);
                    }
                    SecurityService.Logout();
                    Navigation.NavigateTo("login", forceLoad: true);
                }
            }
        }
        catch (Exception)
        {
            if (Application.Current?.MainPage != null)
            {
                await Application.Current.MainPage.DisplayAlert("Error", "Reset failed.", "OK");
            }
        }
    }
}

<style>
    .settings-container { max-width: 800px; margin: 0 auto; padding: 20px; color: var(--text-main); }
    .settings-header { margin-bottom: 2rem; }
    .settings-content { display: flex; flex-direction: column; gap: 1.5rem; }
    .settings-section { background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow); }
    .settings-section h2 { font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; color: var(--text-main); }
    .setting-item { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .setting-info { flex: 1; }
    .setting-title { font-weight: 600; color: var(--text-main); }
    .setting-description { font-size: 0.875rem; color: var(--text-muted); }
    
    .export-range-form { display: flex; gap: 1rem; align-items: flex-end; margin-top: 1rem; flex-wrap: wrap; }
    .date-input-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .date-input-group label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; }
    .setting-input-date { padding: 0.4rem !important; font-size: 0.8rem !important; width: 140px; }

    .pin-change-form { display: flex; gap: 0.5rem; }
    .setting-input { width: 80px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; text-align: center; background: var(--bg-input); color: var(--text-main); }
    .action-btn { padding: 0.5rem 1.5rem; border-radius: 100px; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; font-weight: 600; color: var(--text-main); transition: 0.2s; }
    .action-btn:hover { border-color: var(--primary); color: var(--primary); }
    .action-btn.primary { background: var(--primary); color: white; border: none; }
    .action-btn.primary:disabled { background: var(--text-muted); cursor: not-allowed; }
    .action-btn.danger { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
    .status-msg { margin-top: 1rem; font-size: 0.875rem; color: var(--primary); font-weight: 600; }
    .status-msg.error { color: #ef4444; }
    .danger-zone { border: 1px solid #fee2e2; }
    .about-info { text-align: center; padding: 1rem; }
    .app-logo { font-size: 3rem; margin-bottom: 0.5rem; }
    .app-name { font-weight: 700; color: var(--text-main); }
    .app-version { color: var(--text-muted); font-size: 0.8rem; }
</style>
