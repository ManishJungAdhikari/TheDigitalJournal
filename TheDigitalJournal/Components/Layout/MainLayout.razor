@inherits LayoutComponentBase
@using TheDigitalJournal.Services
@using Microsoft.Maui.Controls
@inject ISecurityService SecurityService
@inject IThemeService ThemeService
@inject NavigationManager Navigation
@implements IDisposable

<div class="luxury-shell @(ThemeService.IsDarkMode ? "theme-dark" : "")">
    @if (SecurityService.IsAuthenticated)
    {
        <aside class="sidebar">
            <div class="brand">
                <span class="logo-mark">✧</span>
                <span class="brand-name">Journal</span>
            </div>

            <nav class="sidebar-nav">
                <NavLink class="nav-item" href="" Match="NavLinkMatch.All">
                    <span class="icon">◆</span> <span>Overview</span>
                </NavLink>
                <NavLink class="nav-item" href="today">
                    <span class="icon">✒</span> <span>New Entry</span>
                </NavLink>
                <div class="nav-divider"></div>
                <NavLink class="nav-item" href="entries">
                    <span class="icon">≡</span> <span>Archive</span>
                </NavLink>
                <NavLink class="nav-item" href="calendar">
                    <span class="icon">◩</span> <span>Calendar</span>
                </NavLink>
                <NavLink class="nav-item" href="analytics">
                    <span class="icon">⌬</span> <span>Insights</span>
                </NavLink>
                
                <div class="spacer"></div>
                
                <NavLink class="nav-item" href="settings">
                    <span class="icon">⚙</span> <span>Settings</span>
                </NavLink>
                <button class="nav-item logout" @onclick="Logout">
                    <span class="icon">⏻</span> <span>Sign Out</span>
                </button>
            </nav>
        </aside>

        <main class="viewport">
            <header class="luxury-top">
                <div class="page-context">
                    <span class="path">Personal /</span> <span class="current-page">Reflections</span>
                </div>
                
                <div class="controls">
                    <button class="theme-switch" @onclick="ThemeService.ToggleTheme">
                        @(ThemeService.IsDarkMode ? "LIGHT MODE" : "DARK MODE")
                    </button>
                    <div class="avatar-ring">
                        <div class="avatar-fill"></div>
                    </div>
                </div>
            </header>

            <div class="content-container">
                @Body
            </div>
        </main>
    }
    else
    {
        <main class="auth-fullscreen">
            @Body
        </main>
    }
</div>

@code {
    protected override void OnInitialized() 
    { 
        ThemeService.OnThemeChanged += HandleThemeChanged; 
        if (!SecurityService.IsAuthenticated && !Navigation.Uri.EndsWith("/login"))
            Navigation.NavigateTo("login");
    }

    private void HandleThemeChanged() 
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose() 
    { 
        ThemeService.OnThemeChanged -= HandleThemeChanged; 
    }

    private void Logout() 
    { 
        SecurityService.Logout(); 
        Navigation.NavigateTo("login"); 
    }
}

<style>
    .luxury-shell { display: flex; height: 100vh; width: 100vw; background-color: var(--bg-page); }
    
    /* Elegant Sidebar */
    .sidebar { 
        width: 240px; 
        background: linear-gradient(180deg, #0f172a 0%, #1e1b4b 100%) !important; 
        color: #fff; 
        display: flex; 
        flex-direction: column; 
        padding: 3rem 1.5rem; 
        flex-shrink: 0; 
        box-shadow: 4px 0 20px rgba(0,0,0,0.4); 
    }
    .brand { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 4rem; padding-left: 0.5rem; }
    .logo-mark { color: var(--accent); font-size: 1.5rem; }
    .brand-name { font-size: 1.4rem; font-weight: 200; letter-spacing: 0.1em; text-transform: uppercase; }
    
    .sidebar-nav { flex: 1; display: flex; flex-direction: column; }
    .nav-item { display: flex; align-items: center; gap: 1rem; padding: 0.9rem 1rem; color: rgba(255,255,255,0.5); text-decoration: none; font-size: 0.9rem; font-weight: 300; letter-spacing: 0.05em; border-radius: 12px; margin-bottom: 0.5rem; border: none; background: none; width: 100%; text-align: left; cursor: pointer; transition: all 0.2s; }
    .nav-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .nav-item.active { color: #fff; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); }
    .nav-divider { height: 1px; background: rgba(255,255,255,0.05); margin: 1.5rem 0; }
    .spacer { flex: 1; }
    
    /* Viewport & Header */
    .viewport { flex: 1; display: flex; flex-direction: column; min-width: 0; background-color: var(--bg-page); }
    .luxury-top { height: 80px; display: flex; align-items: center; justify-content: space-between; padding: 0 3rem; background-color: var(--bg-page); flex-shrink: 0; border-bottom: 1px solid var(--border); }
    .page-context { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em; }
    .page-context .path { color: var(--text-muted); }
    .page-context .current-page { color: var(--primary); font-weight: 700; }
    
    .controls { display: flex; align-items: center; gap: 2rem; }
    .theme-switch { background: none; border: 1px solid var(--border); padding: 0.4rem 1rem; border-radius: 100px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); cursor: pointer; }
    .theme-switch:hover { border-color: var(--primary); color: var(--primary); }
    
    .avatar-ring { width: 36px; height: 36px; border: 1px solid var(--border); padding: 3px; border-radius: 50%; }
    .avatar-fill { width: 100%; height: 100%; background: var(--primary); border-radius: 50%; }
    
    .content-container { flex: 1; overflow-y: auto; padding: 3rem; background-color: var(--bg-page); }
    .auth-fullscreen { flex: 1; display: flex; align-items: center; justify-content: center; background-color: var(--bg-page); }
</style>